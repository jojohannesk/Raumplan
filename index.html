<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freie Räume – Live (vollständig)</title>
  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --accent:#2a7; --muted:#657;
    }
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:18px;display:flex;justify-content:center}
    .wrap{max-width:1100px;width:100%}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:22px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .box{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(12,20,30,0.06)}
    label{font-size:13px;color:var(--muted);display:block}
    select,input[type="time"],input[type="date"],input[type="text"]{
      display:block;width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ee;margin-top:6px
    }
    .small{font-size:13px;color:var(--muted);margin-top:6px}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .room-pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1f9f1;border:1px solid #e6f3ea;margin:4px;cursor:pointer}
    .room-pill.taken{background:#fff2f2;border-color:#ffdfdf;opacity:0.6}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center}
    hr{border:none;border-top:1px solid #eee;margin:12px 0}
    pre.small{white-space:pre-wrap;font-family:inherit}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Freie Räume – Live (komplett)</h1>
      
    </header>

    <div class="grid">

      <!-- LIVE -->
      <div class="box">
        <h3>Live-Anzeige</h3>
        <label for="liveDate">Datum</label>
        <input type="date" id="liveDate">

        <label for="liveTime" style="margin-top:8px">Uhrzeit</label>
        <input type="time" id="liveTime" step="60">

        <label style="margin-top:8px"><input type="checkbox" id="filterPianoLive"> Nur Räume mit Flügel</label>

        <div id="liveStatus" class="small" style="margin-top:10px">Letzte Aktualisierung: <span id="lastSync">–</span></div>
        <div id="liveFree" style="margin-top:8px;font-weight:700;color:var(--accent)"></div>
        <div id="liveRoomList" class="small" style="margin-top:8px"></div>
        <div style="margin-top:8px" class="small muted">Klicke einen Raum, um das Reservierungsformular vorzubefüllen.</div>
      </div>

      <!-- EINZELABFRAGE -->
      <div class="box">
        <h3>Manuelle Einzelabfrage</h3>
        <label for="singleDate">Datum</label>
        <input type="date" id="singleDate">

        <label style="margin-top:8px">Uhrzeit</label>
        <input type="time" id="singleTime" step="1800">

        <label style="margin-top:8px"><input type="checkbox" id="filterPianoSingle"> Nur Räume mit Flügel</label>

        <div style="margin-top:10px" class="row">
          <button id="btnManualCheck">Prüfen</button>
          <div id="manualResult" class="small" style="margin-left:10px">–</div>
        </div>

        <hr>

        <h4>Reservieren / Override</h4>
        <label for="reserveDate">Datum</label>
        <input type="date" id="reserveDate">

        <label style="margin-top:8px">Slot</label>
        <select id="reserveSlot"></select>

        <label style="margin-top:8px">Raum</label>
        <input type="text" id="reserveRoom" placeholder="z. B. R4">

        <label style="margin-top:8px">Dein Name</label>
        <input type="text" id="reserveName" placeholder="z. B. Johannes">

        <div style="margin-top:8px" class="row">
          <button id="btnReserve">Reservieren</button>
          <button id="btnOverrideFree" style="background:#2a7;">Override: Dann frei</button>
          <button id="btnOverrideTaken" style="background:#ff6b6b">Override: Dann belegt</button>
        </div>
        <div id="reserveNotice" class="small" style="margin-top:8px">–</div>
       <h4>Zeitraum reservieren</h4>

<label>Datum</label>
<input type="date" id="rangeDate">

<div class="row" style="margin-top:8px">
  <div style="flex:1">
    <label>Start</label>
    <input type="time" id="rangeStart" step="1800">
  </div>
  <div style="flex:1">
    <label>Ende</label>
    <input type="time" id="rangeEnd" step="1800">
  </div>
</div>

<label style="margin-top:8px">Raum</label>
<input type="text" id="rangeRoom" placeholder="z.B. R4">

<label style="margin-top:8px">Dein Name</label>
<input type="text" id="rangeName" placeholder="z.B. Lukas">

<button id="btnReserveRange" style="margin-top:8px;background:#2a7">Zeitraum reservieren</button>

<div id="rangeNotice" class="small" style="margin-top:8px">–</div>


      <hr style="margin-top:20px">
 
      </div>
      

      <!-- ZEITFENSTER & TAGESPLAN -->
      <div class="box">
        <h3>Zeitfenster prüfen</h3>
        <label for="windowDate">Datum</label>
        <input type="date" id="windowDate">

        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Start</label>
            <input type="time" id="windowStart" step="1800">
          </div>
          <div style="flex:1">
            <label>Ende</label>
            <input type="time" id="windowEnd" step="1800">
          </div>
        </div>

        <label style="margin-top:8px"><input type="checkbox" id="filterPianoWindow"> Nur Räume mit Flügel</label>

        <div style="margin-top:10px" class="row">
          <button id="btnCheckWindow">Zeitfenster prüfen</button>
          <button id="btnShowDayPlan" style="background:#5578ff">Zeige Tagesplan</button>
        </div>

        <div id="windowResult" class="small" style="margin-top:12px">–</div>

        <hr>

        <h4>Tagesplan (Basis + Overrides + Reservierungen)</h4>
        <div id="dayPlan" class="small" style="margin-top:8px">Lade...</div>
      </div>

    </div>
  </div>

  <!-- Firebase ESM via CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, onValue, get, set, push, child
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ------------------- FIREBASE CONFIG -------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAeqhQhTayYp4T7BIHRxn8iGPLaM0bqy5o",
      authDomain: "freieraume.firebaseapp.com",
      databaseURL: "https://freieraume-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "freieraume",
      storageBucket: "freieraume.firebasestorage.app",
      messagingSenderId: "990554662786",
      appId: "1:990554662786:web:0849d2e4858ab83fead19b",
      measurementId: "G-QTZN90B1NN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ------------------- SCHEDULE (full: paste your full schedule here) -------------------
    // I inserted your complete schedule below as before (Mon-Fri).
    // Keys are english weekday names: Monday, Tuesday, ...
    const schedule = {
  "Monday": {
    "09:00-09:30": "R4, R5, R11, R12, R13, R16, R17",
    "09:30-10:00": "R4, R5, R11, R12, R13, R16, R17",
    "10:00-10:30": "R4, R5, R11, R12, R13, R16, R17",
    "10:30-11:00": "R4, R5, R11, R12, R13, R16, R17",
    "11:00-11:30": "R4, R5, R11, R12, R13, R16, R17",
    "11:30-12:00": "R4, R5, R11, R12, R13, R16, R17",
    "12:00-12:30": "R4, R5, R11, R12, R13, R16, R17",
    "12:30-13:00": "R4, R5, R11, R12, R13, R15, R16, R17",
    "13:00-13:30": "R4, R5, R11, R12, R13, R15, R16, R17",
    "13:30-14:00": "R4, R5, R11, R13, R15, R17",
    "14:00-14:30": "R4, R5, R13, R15, R16, R17",
    "14:30-15:00": "R5, R13, R15, R17",
    "15:00-15:30": "R5, R13, R15, R17",
    "15:30-16:00": "R5, R13, R15, R17",
    "16:00-16:30": "R5, R13, R17",
    "16:30-17:00": "R5, R17",
    "17:00-17:30": "R5, R17",
    "17:30-18:00": "R5, R15, R17",
    "18:00-18:30": "R5, R15, R16, R17",
    "18:30-19:00": "R5, R11, R12, R15, R16, R17",
    "19:00-19:30": "R5, R11, R13, R15, R16, R17",
    "19:30-20:00": "R5, R11, R13, R15, R16, R17",
    "20:00-20:30": "R5, R11, R13, R15, R16, R17",
    "20:30-21:00": "R5, R11, R12, R13, R15, R16, R17",
    "21:00-21:30": "R4, R5, R11, R12, R13, R15, R16, R17",
    "21:30-22:00": "R4, R5, R11, R12, R13, R15, R16, R17"
  },
  "Tuesday": {
    "09:00-09:30": "R4, R5, R11, R12, R13, R16, R17",
    "09:30-10:00": "R4, R5, R11, R12, R13, R16, R17",
    "10:00-10:30": "R4, R5, R11, R12, R13, R16, R17",
    "10:30-11:00": "R5, R11, R12, R13, R16, R17",
    "11:00-11:30": "R5, R11, R12, R13, R16, R17",
    "11:30-12:00": "R5, R11, R12, R13, R16, R17",
    "12:00-12:30": "R4, R5, R11, R12, R13, R16, R17",
    "12:30-13:00": "R4, R5, R11, R12, R13, R15, R16, R17",
    "13:00-13:30": "R4, R5, R12, R13, R15, R16, R17",
    "13:30-14:00": "R4, R5, R13, R15, R16, R17",
    "14:00-14:30": "R4, R5, R13, R15, R16, R17",
    "14:30-15:00": "R4, R5, R13, R15, R17",
    "15:00-15:30": "R4, R13, R15, R17",
    "15:30-16:00": "R4, R13, R15, R17",
    "16:00-16:30": "R4, R13, R15, R17",
    "16:30-17:00": "R4, R13, R15, R17",
    "17:00-17:30": "R4, R13, R15, R17",
    "17:30-18:00": "R4, R5, R13, R15, R17",
    "18:00-18:30": "R4, R5, R11, R13, R15, R17",
    "18:30-19:00": "R5, R11, R13, R15, R16, R17",
    "19:00-19:30": "R5, R11, R13, R15, R16, R17",
    "19:30-20:00": "R5, R11, R12, R13, R15, R16",
    "20:00-20:30": "R5, R11, R12, R13, R15, R16",
    "20:30-21:00": "R5, R11, R12, R13, R15, R16, R17",
    "21:00-21:30": "R5, R11, R12, R13, R15, R16, R17",
    "21:30-22:00": "R5, R11, R12, R13, R15, R16, R17"
  },
  "Wednesday": {
    "09:00-09:30": "R4, R11, R12, R13, R16, R17",
    "09:30-10:00": "R4, R11, R12, R13, R16, R17",
    "10:00-10:30": "R4, R11, R12, R13, R16, R17",
    "10:30-11:00": "R4, R11, R12, R13, R16, R17",
    "11:00-11:30": "R4, R5, R11, R12, R13, R16, R17",
    "11:30-12:00": "R4, R5, R11, R12, R13, R16, R17",
    "12:00-12:30": "R4, R5, R11, R12, R13, R16, R17",
    "12:30-13:00": "R4, R11, R12, R13, R16, R17",
    "13:00-13:30": "R4, R16",
    "13:30-14:00": "R4, R5, R16",
    "14:00-14:30": "R4, R5, R16",
    "14:30-15:00": "R4, R5",
    "15:00-15:30": "R4",
    "15:30-16:00": "R4",
    "16:00-16:30": "",
    "16:30-17:00": "",
    "17:00-17:30": "",
    "17:30-18:00": "R5",
    "18:00-18:30": "R4",
    "18:30-19:00": "R4, R12, R15, R16",
    "19:00-19:30": "R4, R11, R12, R13, R16, R17",
    "19:30-20:00": "R4, R11, R12, R13, R16, R17",
    "20:00-20:30": "R4, R11, R12, R13, R16, R17",
    "20:30-21:00": "R11, R12, R13, R15, R16, R17",
    "21:00-21:30": "R11, R12, R13, R15, R16, R17",
    "21:30-22:00": "R11, R12, R13, R15, R16, R17"
  },
  "Thursday": {
    "09:00-09:30": "R4, R5, R11, R12, R13, R15, R16, R17",
    "09:30-10:00": "R4, R5, R11, R12, R13, R15, R16, R17",
    "10:00-10:30": "R4, R5,R11, R12, R13, R16, R17",
    "10:30-11:00": "R4, R5, R11, R12, R13, R16, R17",
    "11:00-11:30": "R4, R5, R11, R12, R13, R16, R17",
    "11:30-12:00": "R4, R5, R11, R12, R13, R16, R17",
    "12:00-12:30": "R4, R5, R11, R12, R13, R16, R17",
    "12:30-13:00": "R4, R5, R11, R13, R16, R17",
    "13:00-13:30": "R4, R5, R11, R16, R17",
    "13:30-14:00": "R4, R5, R11, R16, R17",
    "14:00-14:30": "R4, R5, R16, R17",
    "14:30-15:00": "R4, R5, R17",
    "15:00-15:30": "R5, R17",
    "15:30-16:00": "R5, R17",
    "16:00-16:30": "R5, R17",
    "16:30-17:00": "R5, R17",
    "17:00-17:30": "R5, R17",
    "17:30-18:00": "R5, R17",
    "18:00-18:30": "R5, R12, R17",
    "18:30-19:00": "R5, R12, R16, R17",
    "19:00-19:30": "R5, R11, R12, R13, R16, R17",
    "19:30-20:00": "R5, R11, R12, R13, R16, R17",
    "20:00-20:30": "R4, R5, R11, R12, R13, R16, R17",
    "20:30-21:00": "R5, R11, R12, R13, R16, R17",
    "21:00-21:30": "R5, R11, R12, R13, R16, R17",
    "21:30-22:00": "R5, R11, R12, R13, R16, R17"
  },
  "Friday": {
    "09:00-09:30": "R4, R11, R12, R13, R15, R16, R17",
    "09:30-10:00": "R4, R11, R12, R13, R15, R16, R17",
    "10:00-10:30": "R4, R11, R12, R13, R15, R16, R17",
    "10:30-11:00": "R4, R11, R12, R13, R15, R16, R17",
    "11:00-11:30": "R4, R11, R12, R13, R15, R16, R17",
    "11:30-12:00": "R4, R5, R11, R12, R13, R15, R16, R17",
    "12:00-12:30": "R4, R5, R11, R12, R16, R17",
    "12:30-13:00": "R4, R5, R12, R17",
    "13:00-13:30": "R4, R5, R12, R17",
    "13:30-14:00": "R4, R5, R12, R17",
    "14:00-14:30": "R4, R12, R17",
    "14:30-15:00": "R12, R17",
    "15:00-15:30": "R17",
    "15:30-16:00": "R17",
    "16:00-16:30": "R5, R12, R17",
    "16:30-17:00": "R5, R12, R17",
    "17:00-17:30": "R5, R12, R17",
    "17:30-18:00": "R5, R12, R17",
    "18:00-18:30": "R5, R12, R17",
    "18:30-19:00": "R5, R11, R12, R17",
    "19:00-19:30": "R5, R11, R12, R13, R17",
    "19:30-20:00": "R5, R11, R12, R13, R17",
    "20:00-20:30": "R5, R11, R12, R13, R16, R17",
    "20:30-21:00": "R5, R11, R12, R13, R16, R17",
    "21:00-21:30": "R4, R5, R11, R12, R13, R16, R17",
    "21:30-22:00": "R4, R5, R11, R12, R13, R16, R17"
  }
}; // end schedule

    // ------------------- piano map -------------------
    const hasPiano = {"R4":true,"R5":false,"R11":true,"R12":false,"R13":true,"R15":false,"R16":false,"R17":false};

    // ------------------- local caches -------------------
    let overridesCache = {};    // overridesCache[date][slot] = { R4: 'frei'|'belegt' }
    let reservationsCache = {}; // reservationsCache[date][slot] = [ { room, user, ts } ]

    // ------------------- helpers -------------------
    const toMinutes = t => { if(!t) return 0; const [h,m]=t.split(":").map(Number); return h*60+m; };
    const weekdayName = dateStr => new Date(dateStr + "T00:00").toLocaleDateString("en-US",{weekday:"long"});
    const emptyIf = v => v === undefined || v === null ? {} : v;

    // find slot for time (uses schedule keys)
    function findSlotForTime(dateStr, timeStr){
      const wd = weekdayName(dateStr);
      const day = schedule[wd] || {};
      const minutes = toMinutes(timeStr);
      for(const range in day){
        const [s,e] = range.split("-");
        if(minutes >= toMinutes(s) && minutes < toMinutes(e)) return range;
      }
      return null;
    }

    function baseFreeRooms(dateStr, slot){
      const wd = weekdayName(dateStr);
      const day = schedule[wd] || {};
      const base = day[slot] || "";
      return base.split(",").map(s=>s.trim()).filter(Boolean);
    }

    function applyOverridesAndReservations(dateStr, slot, rooms){
      let r = rooms.slice();
      const o = overridesCache?.[dateStr]?.[slot] || {};
      for(const room in o){
        if(o[room] === "frei"){
          if(!r.includes(room)) r.push(room);
        } else if(o[room] === "belegt"){
          r = r.filter(x => x !== room);
        }
      }
      const res = reservationsCache?.[dateStr]?.[slot] || [];
      res.forEach(it => { r = r.filter(x => x !== it.room); });
      return r;
    }

    // ------------------- UI ELEMENTS -------------------
    const el = {
      liveDate: document.getElementById("liveDate"),
      liveTime: document.getElementById("liveTime"),
      filterPianoLive: document.getElementById("filterPianoLive"),
      liveFree: document.getElementById("liveFree"),
      liveRoomList: document.getElementById("liveRoomList"),
      lastSync: document.getElementById("lastSync"),

      singleDate: document.getElementById("singleDate"),
      singleTime: document.getElementById("singleTime"),
      filterPianoSingle: document.getElementById("filterPianoSingle"),
      btnManualCheck: document.getElementById("btnManualCheck"),
      manualResult: document.getElementById("manualResult"),

      reserveDate: document.getElementById("reserveDate"),
      reserveSlot: document.getElementById("reserveSlot"),
      reserveRoom: document.getElementById("reserveRoom"),
      reserveName: document.getElementById("reserveName"),
      btnReserve: document.getElementById("btnReserve"),
      btnOverrideFree: document.getElementById("btnOverrideFree"),
      btnOverrideTaken: document.getElementById("btnOverrideTaken"),
      reserveNotice: document.getElementById("reserveNotice"),

      windowDate: document.getElementById("windowDate"),
      windowStart: document.getElementById("windowStart"),
      windowEnd: document.getElementById("windowEnd"),
      filterPianoWindow: document.getElementById("filterPianoWindow"),
      btnCheckWindow: document.getElementById("btnCheckWindow"),
      windowResult: document.getElementById("windowResult"),

      dayPlan: document.getElementById("dayPlan"),
      btnShowDayPlan: document.getElementById("btnShowDayPlan")
    };

    // populate slots select (30-min from 07:00 to 22:00)
    const canonicalSlots = [];
    for(let h=7; h<22; h++){
      const m1 = `${String(h).padStart(2,'0')}:00`;
      const m2 = `${String(h).padStart(2,'0')}:30`;
      const m3 = `${String(h+1).padStart(2,'0')}:00`;
      canonicalSlots.push(`${m1}-${m2}`, `${m2}-${m3}`);
    }
    canonicalSlots.forEach(s => {
      const o = document.createElement("option");
      o.value = s; o.textContent = s; el.reserveSlot.appendChild(o);
    });

    // defaults
    const today = new Date().toISOString().split("T")[0];
    el.liveDate.value = today; el.singleDate.value = today; el.reserveDate.value = today; el.windowDate.value = today;
    el.liveTime.value = new Date().toTimeString().slice(0,5);

    // ------------------- Firebase listeners -------------------
    const overridesRef = ref(db, "overrides");
    const reservationsRef = ref(db, "reservations");

    // keep caches in sync
    onValue(overridesRef, snapshot => {
      overridesCache = snapshot.val() || {};
      renderAll(); // update UI
    }, error => {
      console.error("overrides read error", error);
    });

    onValue(reservationsRef, snapshot => {
      reservationsCache = snapshot.val() || {};
      renderAll();
    }, error => {
      console.error("reservations read error", error);
    });

    // ------------------- Render / UI functions -------------------
    function renderLive(){
      const date = el.liveDate.value;
      const time = el.liveTime.value;
      el.lastSync = document.getElementById("lastSync");
      el.lastSync.textContent = new Date().toLocaleTimeString();
      el.liveRoomList.innerHTML = "";

      if(!date || !time) { el.liveFree.textContent = "Bitte Datum & Uhrzeit wählen"; return; }

      const slot = findSlotForTime(date, time);
      if(!slot){ el.liveFree.textContent = "Außerhalb der Öffnungszeiten"; return; }

      let list = baseFreeRooms(date, slot);
      list = applyOverridesAndReservations(date, slot, list);
      if(el.filterPianoLive.checked) list = list.filter(r => hasPiano[r]);

      el.liveFree.textContent = list.length ? `Jetzt frei: ${list.join(", ")}` : "Keine Räume frei";
      list.forEach(r => {
        const span = document.createElement("span");
        span.className = "room-pill";
        span.textContent = r;
        span.onclick = () => {
          // prefill reserve form
          el.reserveDate.value = date;
          el.reserveSlot.value = slot;
          el.reserveRoom.value = r;
          el.reserveNotice.textContent = `Vorauswahl: ${r} • ${date} ${slot}`;
        };
        el.liveRoomList.appendChild(span);
      });
    }

    function renderDayPlan(){
      const d = el.reserveDate.value || today;
      const wd = weekdayName(d);
      const daySched = schedule[wd] || {};
      let html = "";
      for(const range in daySched){
        const baseRooms = (daySched[range]||"").split(",").map(x=>x.trim()).filter(Boolean);
        const o = overridesCache?.[d]?.[range] || {};
        const res = reservationsCache?.[d]?.[range] || [];
        const baseHtml = baseRooms.map(r => `<span class="room-pill">${r}</span>`).join(" ");
        html += `<div style="margin-bottom:8px"><strong>${range}</strong>: ${baseHtml}`;
        if(Object.keys(o).length){
          html += `<div class="small muted">Overrides: ${Object.entries(o).map(([rr,s])=>rr+':'+s).join(', ')}</div>`;
        }
        if(res.length){
          html += `<div class="small muted">Reserviert: ${res.map(x=>x.room+" ("+x.user+")").join(', ')}</div>`;
        }
        html += `</div>`;
      }
      el.dayPlan.innerHTML = html || "Kein Plan für diesen Wochentag.";
    }

    function renderAll(){
      renderLive();
      renderDayPlan();
    }

    // ------------------- User actions (writes) -------------------
    // Reserve: push to /reservations/{date}/{slot} (array stored as object)
    async function doReserve(){
      const date = el.reserveDate.value;
      const slot = el.reserveSlot.value;
      const room = (el.reserveRoom.value||"").trim().toUpperCase();
      const user = (el.reserveName.value||"").trim() || "anonym";
      if(!date || !slot || !room){ el.reserveNotice.textContent = "Bitte Datum, Slot und Raum wählen"; return; }

      try{
        const node = child(ref(db), `reservations/${date}/${slot}`);
        const snap = await get(node);
        const list = snap.exists() ? (snap.val() || []) : [];
        // ensure unique by room
        if(list.find(x => x.room === room)){
          el.reserveNotice.textContent = "Dieser Raum ist bereits reserviert für den Slot.";
          return;
        }
        list.push({ room, user, ts: Date.now() });
        await set(node, list);
        el.reserveNotice.textContent = "Reservierung erfolgreich.";
      }catch(err){
        console.error("reserve error", err);
        el.reserveNotice.textContent = "Fehler beim Reservieren (Konsole prüfen).";
      }
    }

    // Reserviert einen kompletten Zeitraum
async function doReserveRange() {
  const date = document.getElementById("rangeDate").value;
  const startStr = document.getElementById("rangeStart").value;
  const endStr = document.getElementById("rangeEnd").value;
  const room = document.getElementById("rangeRoom").value.trim().toUpperCase();
  const user = document.getElementById("rangeName").value.trim() || "anonym";

  const notice = document.getElementById("rangeNotice");

  if (!date || !startStr || !endStr || !room) {
    notice.textContent = "Bitte alle Felder ausfüllen.";
    return;
  }

  const start = toMinutes(startStr);
  const end = toMinutes(endStr);

  if (start >= end) {
    notice.textContent = "Ende muss nach Start liegen.";
    return;
  }

  // Finde alle betroffenen Slots
  const slots = [];
  for (const slot of canonicalSlots) {
    const [s,e] = slot.split("-");
    const sMin = toMinutes(s);
    const eMin = toMinutes(e);

    // Überschneidung prüfen
    if (!(eMin <= start || sMin >= end)) {
      slots.push(slot);
    }
  }

  try {
    for (const slot of slots) {
      const node = child(ref(db), `reservations/${date}/${slot}`);
      const snap = await get(node);
      const list = snap.exists() ? snap.val() : [];

      // Prüfen ob Raum schon belegt ist
      if (list.find(x => x.room === room)) {
        notice.textContent = `Fehler: Der Raum ${room} ist bereits im Slot ${slot} reserviert.`;
        return;
      }
    }

    // Wenn kein Konflikt → alle Slots reservieren
    for (const slot of slots) {
      const node = child(ref(db), `reservations/${date}/${slot}`);
      const snap = await get(node);
      const list = snap.exists() ? snap.val() : [];
      list.push({ room, user, ts: Date.now() });
      await set(node, list);
    }

    notice.textContent = `Zeitraum erfolgreich reserviert (${slots.length} Slots).`;

  } catch (err) {
    console.error("range reserve error", err);
    notice.textContent = "Fehler beim Reservieren (Konsole prüfen).";
  }
}

    // set override: /overrides/{date}/{slot}/{room} = 'frei'|'belegt'
    async function doSetOverride(state){
      const date = el.reserveDate.value;
      const slot = el.reserveSlot.value;
      const room = (el.reserveRoom.value||"").trim().toUpperCase();
      if(!date || !slot || !room){ el.reserveNotice.textContent = "Bitte Datum, Slot und Raum wählen"; return; }
      try{
        const path = `overrides/${date}/${slot}/${room}`;
        await set(child(ref(db), path), state);
        el.reserveNotice.textContent = `Override gesetzt: ${room} → ${state}`;
      }catch(err){
        console.error("override error", err);
        el.reserveNotice.textContent = "Fehler beim Setzen des Overrides.";
      }
    }

    // ------------------- Queries (reads) -------------------
    function doManualCheck(){
      const date = el.singleDate.value;
      const time = el.singleTime.value;
      if(!date || !time){ el.manualResult.textContent = "Bitte Datum & Uhrzeit wählen"; return; }
      const slot = findSlotForTime(date, time);
      if(!slot){ el.manualResult.textContent = "Außerhalb der Öffnungszeiten"; return; }
      let list = baseFreeRooms(date, slot);
      list = applyOverridesAndReservations(date, slot, list);
      if(el.filterPianoSingle.checked) list = list.filter(r => hasPiano[r]);
      el.manualResult.textContent = list.length ? `Frei: ${list.join(", ")}` : "Keine Räume frei";
    }

    function doWindowCheck(){
      const date = el.windowDate.value;
      const s = el.windowStart.value;
      const e = el.windowEnd.value;
      if(!date || !s || !e){ el.windowResult.textContent = "Bitte Datum, Start & Ende wählen"; return; }
      const base = schedule[weekdayName(date)] || {};
      const start = toMinutes(s), end = toMinutes(e);
      if(start >= end){ el.windowResult.textContent = "Ende muss nach Start liegen"; return; }
      let common = null;
      for(const range in base){
        const [rs,re] = range.split("-");
        const r1 = toMinutes(rs), r2 = toMinutes(re);
        if(r2 <= start || r1 >= end) continue;
        let free = base[range].split(",").map(x=>x.trim()).filter(Boolean);
        free = applyOverridesAndReservations(date, range, free);
        if(el.filterPianoWindow.checked) free = free.filter(r => hasPiano[r]);
        if(common === null) common = new Set(free); else common = new Set(free.filter(x => common.has(x)));
      }
      const arr = common ? Array.from(common) : [];
      el.windowResult.textContent = arr.length ? `Komplett frei: ${arr.join(", ")}` : "Keine Räume komplett frei im Fenster";
    }

    // ------------------- Event bindings -------------------
    el.liveDate.addEventListener("change", renderLive);
    el.liveTime.addEventListener("change", renderLive);
    el.filterPianoLive.addEventListener("change", renderLive);

    el.btnManualCheck.addEventListener("click", doManualCheck);
    el.btnCheckWindow.addEventListener("click", doWindowCheck);
    el.btnShowDayPlan.addEventListener("click", renderDayPlan);

    el.btnReserve.addEventListener("click", doReserve);
    document.getElementById("btnReserveRange").addEventListener("click", doReserveRange);
    el.btnOverrideFree.addEventListener("click", () => doSetOverride("frei"));
    el.btnOverrideTaken.addEventListener("click", () => doSetOverride("belegt"));

    // periodic auto-update of live (in case time passes)
    setInterval(renderLive, 15000);

    // initial render
    renderAll();

    // Small helper: log if permission denied reading DB (to help debugging)
    // (listeners above already print errors)
  </script>
</body>
</html>
